<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChromaCore: Cyber-Glass Visualizer</title>
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root {
            /* CYBER NEONS */
            --neon-pink: #ff0055;
            --neon-green: #00ff99;
            --neon-cyan: #00d9ff;
            --neon-purple: #bc13fe;
            --glass-base: rgba(10, 15, 25, 0.4); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --blur-fx: blur(15px) saturate(180%);
            --bg-deep: #010409;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: var(--bg-deep); font-family: 'Inter', sans-serif; color: #fff; display: flex; height: 100vh; width: 100vw; }

        /* --- THE UNDERLAY --- */
        #cyber-underlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; overflow: hidden; }
        .grid-plane {
            position: absolute; width: 200%; height: 200%;
            background-image: linear-gradient(rgba(0, 217, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 217, 255, 0.05) 1px, transparent 1px);
            background-size: 60px 60px; transform: perspective(600px) rotateX(65deg);
            top: -50%; left: -50%; animation: grid-move 15s linear infinite;
        }
        @keyframes grid-move { from { transform: perspective(600px) rotateX(65deg) translateY(0); } to { transform: perspective(600px) rotateX(65deg) translateY(60px); } }
        .glow-orb { position: absolute; filter: blur(100px); opacity: 0.4; border-radius: 50%; animation: orb-float 20s infinite ease-in-out; }
        .orb-1 { width: 50vw; height: 50vw; background: var(--neon-purple); top: -10%; left: 0%; }
        .orb-2 { width: 45vw; height: 45vw; background: var(--neon-pink); bottom: 0%; right: -5%; animation-delay: -7s; }

        /* --- SCAN REFRESH BAR --- */
        #global-scan {
            position: absolute; top: 0; left: -30%; width: 25vw; height: 100%;
            background: linear-gradient(to right, transparent, rgba(0, 217, 255, 0.05) 50%, transparent);
            z-index: 1; pointer-events: none; animation: scan-move 8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        @keyframes scan-move { 0% { left: -30vw; } 100% { left: 110vw; } }

        /* --- MAIN VIEW --- */
        #canvas-container { flex: 1; position: relative; z-index: 2; display: flex; flex-direction: column; overflow: hidden; }
        #main-visualizer { flex: 1; width: 100%; height: 100%; display: block; cursor: grab; }
        #main-database { 
            flex: 1; width: 100%; height: 100%; display: none; overflow-y: auto; padding: 40px; 
            -webkit-overflow-scrolling: touch; background: rgba(0,0,0,0.1); 
        }

        /* --- MODE SWITCHER (Bottom Left) --- */
        #mode-switcher {
            position: absolute; bottom: 25px; left: 25px; z-index: 1000;
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(15px); border: 1px solid var(--glass-border);
            padding: 5px; border-radius: 12px; display: flex; gap: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .mode-btn {
            background: transparent; border: none; padding: 10px 18px; border-radius: 8px;
            font-family: 'Orbitron', sans-serif; font-size: 0.65rem; font-weight: 900;
            color: #555; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .mode-btn.active { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

        /* --- SIDEBAR --- */
        #sidebar { 
            position: relative; width: 420px; height: 100vh; z-index: 100; display: flex; flex-direction: column;
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            background: var(--glass-base); backdrop-filter: var(--blur-fx); -webkit-backdrop-filter: var(--blur-fx);
            box-shadow: -15px 0 50px rgba(0,0,0,0.7); overflow: hidden;
        }
        #sidebar::after {
            content: ''; position: absolute; inset: 0; pointer-events: none; z-index: 1000;
            background: linear-gradient(0deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 100% 1000%; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: destination-out; mask-composite: exclude; padding: 2px; animation: rgb-slide 10s linear infinite;
        }
        @keyframes rgb-slide { from { background-position: 0% 0%; } to { background-position: 0% 100%; } }

        /* --- SIDEBAR VARIATIONS --- */
        #sidebar-visualizer-ui { flex: 1; display: flex; flex-direction: column; height: 100%; }
        #sidebar-database-ui { flex: 1; display: none; flex-direction: column; height: 100%; padding: 25px; overflow-y: auto; }

        .logo-box { padding: 25px 20px 5px; text-align: center; }
        .logo { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; font-weight: 900; letter-spacing: -1.5px; margin: 0; }

        .cyber-tab-module { margin: 20px; border-radius: 12px; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); overflow: hidden; flex-shrink: 0; }
        .tabs-header { display: flex; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--glass-border); }
        .tab-btn { flex: 1; padding: 14px; background: transparent; border: none; color: #555; font-family: 'Orbitron', sans-serif; font-size: 0.7rem; font-weight: 900; cursor: pointer; transition: 0.3s; letter-spacing: 1.5px; }
        .tab-btn.active { color: var(--neon-cyan); background: rgba(0, 217, 255, 0.08); text-shadow: 0 0 10px rgba(0, 217, 255, 0.4); }
        .tab-content { padding: 15px; display: none; }
        .tab-content.active { display: block; }

        input, select, textarea {
            background: rgba(0,0,0,0.6); border: 1px solid var(--glass-border); color: #fff;
            padding: 12px; border-radius: 8px; font-family: 'Inter', sans-serif; outline: none;
            transition: all 0.3s; width: 100%; font-size: 14px; resize: none;
        }
        input:focus, textarea:focus { border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 217, 255, 0.2); background: rgba(0,0,0,0.7); }

        /* --- LIST ZONE --- */
        #list-container { flex: 1; min-height: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        #stack-list { padding: 0; margin: 0; list-style: none; }
        .stack-item { display: flex; align-items: center; padding: 20px; cursor: pointer; transition: 0.2s; position: relative; }
        .stack-item::after {
            content: ''; position: absolute; bottom: 0; left: 10px; right: 10px; height: 1.5px;
            background: linear-gradient(90deg, transparent, #ff0000, #00ff00, #0000ff, transparent);
            background-size: 200% 100%; animation: rgb-h-slide 6s linear infinite; opacity: 0.3;
        }
        @keyframes rgb-h-slide { from { background-position: 0% 0%; } to { background-position: 200% 0%; } }
        .swatch { width: 44px; height: 44px; border-radius: 8px; margin-right: 20px; border: 1px solid rgba(255,255,255,0.25); flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        /* --- SUBMISSION MODULE --- */
        .submit-section { margin-bottom: 25px; }
        .submit-label { font-family: 'Orbitron', sans-serif; font-size: 0.7rem; color: var(--neon-cyan); letter-spacing: 2px; margin-bottom: 12px; display: block; font-weight: 800; }
        .tag-pool { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 25px; }
        .tag-pill { 
            background: rgba(0, 217, 255, 0.1); border: 1px solid var(--neon-cyan); color: var(--neon-cyan);
            padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-family: 'Orbitron', sans-serif;
            display: flex; align-items: center; gap: 6px; animation: tag-pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes tag-pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .tag-x { cursor: pointer; opacity: 0.5; }
        .tag-x:hover { opacity: 1; color: var(--neon-pink); }
        
        .calculate-btn {
            background: var(--neon-cyan); border: none; padding: 15px; border-radius: 10px;
            color: #000; font-family: 'Orbitron', sans-serif; font-weight: 900; letter-spacing: 2px;
            cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }
        .calculate-btn:hover { transform: scale(1.02); filter: brightness(1.1); box-shadow: 0 0 30px rgba(0, 217, 255, 0.5); }

        .btn-exec-small {
            background: var(--neon-cyan); border: none; border-radius: 8px; padding: 0 15px; 
            font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 0.7rem; cursor: pointer;
            transition: 0.2s;
        }
        .btn-exec-small:hover { filter: brightness(1.1); box-shadow: 0 0 10px var(--neon-cyan); }

        /* --- DB GRID --- */
        .db-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding-bottom: 100px; }
        .db-cell { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(5px); border: 1px solid var(--glass-border); border-radius: 10px; padding: 15px; display: flex; align-items: center; }
        .db-swatch { width: 45px; height: 45px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); margin-right: 15px; flex-shrink: 0; }

        /* FOOTER */
        .sidebar-footer { padding: 15px; background: rgba(0,0,0,0.7); border-top: 1px solid var(--glass-border); display: flex; gap: 10px; }
        .jump-btn { flex: 1; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color: #777; font-family: 'Orbitron', sans-serif; font-size: 0.6rem; padding: 12px 5px; border-radius: 10px; cursor: pointer; transition: 0.3s; font-weight: 900; }
        .jump-btn:hover { color: #fff; border-color: rgba(255,255,255,0.2); }

        #hover-label { position: absolute; padding: 15px; border-radius: 10px; pointer-events: none; display: none; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); border-left: 4px solid var(--neon-cyan); box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-family: 'Orbitron', sans-serif; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="cyber-underlay">
        <div class="grid-plane"></div>
        <div class="glow-orb orb-1"></div>
        <div class="glow-orb orb-2"></div>
    </div>
    <div id="global-scan"></div>

    <div id="mode-switcher">
        <button id="mode-visual" class="mode-btn active" onclick="switchWorkspace('visualizer')">VISUALIZER</button>
        <button id="mode-db" class="mode-btn" onclick="switchWorkspace('database')">DATABASE</button>
    </div>

    <div id="canvas-container">
        <div id="hover-label"></div>
        <div id="main-visualizer"></div>
        <div id="main-database"><div id="db-grid-container" class="db-grid"></div></div>
    </div>

    <aside id="sidebar">
        <!-- VISUALIZER SIDEBAR -->
        <div id="sidebar-visualizer-ui">
            <div class="logo-box"><h2 class="logo">CHROMACORE</h2></div>
            <div class="cyber-tab-module">
                <div class="tabs-header">
                    <button id="btn-registry" class="tab-btn active" onclick="switchTab('registry')">REGISTRY</button>
                    <button id="btn-query" class="tab-btn" onclick="switchTab('query')">QUERY</button>
                </div>
                <div id="tab-registry" class="tab-content active">
                    <select id="zone-select" style="margin-bottom: 12px;"><option value="Core">CORE</option><option value="Mid Zone" selected>MID</option><option value="Outer Band">OUTER</option></select>
                    <div style="display: flex; gap: 10px;"><input type="text" id="assign-input" placeholder="#tag1; #tag2..."><button class="btn-exec-small" onclick="doAssign()">ADD</button></div>
                </div>
                <div id="tab-query" class="tab-content"><input type="text" id="search-input" placeholder="SCAN_DATABASE_LOGS..."></div>
            </div>
            <div id="list-container"><ul id="stack-list"></ul></div>
            <div class="sidebar-footer">
                <button class="jump-btn" onclick="jumpTo('Core')" style="border-bottom: 3px solid var(--neon-pink)">CORE</button>
                <button class="jump-btn" onclick="jumpTo('Mid Zone')" style="border-bottom: 3px solid var(--neon-green)">MID</button>
                <button class="jump-btn" onclick="jumpTo('Outer Band')" style="border-bottom: 3px solid var(--neon-cyan)">OUTER</button>
            </div>
        </div>

        <!-- DATABASE SUBMISSION SIDEBAR -->
        <div id="sidebar-database-ui">
            <div class="logo-box" style="margin-bottom:20px;"><h2 class="logo">NODE_INGEST</h2></div>
            
            <div class="submit-section">
                <label class="submit-label">NODE_LABEL</label>
                <input type="text" id="node-label" placeholder="System identifier..." maxlength="100">
                <div style="font-size:0.6rem; color:#444; text-align:right; margin-top:4px;" id="label-counter">0 / 100</div>
            </div>

            <div class="submit-section">
                <label class="submit-label">SEMANTIC_CONTENT</label>
                <textarea id="node-content" rows="8" placeholder="Enter descriptive data paragraph..."></textarea>
            </div>

            <div class="submit-section">
                <label class="submit-label">ACTIVE_TAG_POOL</label>
                <div id="active-node-tags" class="tag-pool">
                    <span style="font-size:0.65rem; color:#444; font-style:italic;">Scanning content for matches...</span>
                </div>
            </div>

            <div class="submit-section">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="manual-tags-input" placeholder="MANUAL_TAGS (#tag1; #tag2...)">
                    <button class="btn-exec-small" onclick="addManualTagsToPool()">ADD</button>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateChromaNode()">CALCULATE_NODE</button>
        </div>
    </aside>

    <script>
        const STACK_SIZE = 10000;
        const stackData = [];
        let chromaNodes = []; 
        let isDBMode = false;
        
        function halton(index, base) { let f=1, r=0, i=index; while(i>0){ f/=base; r+=f*(i%base); i=Math.floor(i/base); } return r; }
        function lab2rgb(l, a, b) {
            let y = (l + 16) / 116, x = a / 500 + y, z = y - b / 200;
            const f = v => v > 0.008856 ? v**3 : (v - 16/116) / 7.787;
            x = 95.047 * f(x); y = 100 * f(y); z = 108.883 * f(z);
            x/=100; y/=100; z/=100;
            let r=x*3.2406+y*-1.5372+z*-0.4986, g=x*-0.9689+y*1.8758+z*0.0415, bl=x*0.0557+y*-0.2040+z*1.0570;
            const c = v => v > 0.0031308 ? 1.055 * (v**(1/2.4)) - 0.055 : 12.92 * v;
            return [Math.max(0,Math.min(255,Math.round(c(r)*255))), Math.max(0,Math.min(255,Math.round(c(g)*255))), Math.max(0,Math.min(255,Math.round(c(bl)*255)))];
        }

        let maxD = 0;
        for (let i = 1; i <= STACK_SIZE; i++) {
            const L = halton(i, 2) * 100, a = (halton(i, 3) * 255) - 128, b = (halton(i, 5) * 255) - 128;
            const dist = Math.sqrt((L-50)**2 + a**2 + b**2);
            if(dist > maxD) maxD = dist;
            stackData.push({ id: i, L, a, b, dist, hashtag: '', css: `lab(${L}% ${a} ${b})` });
        }
        const rC = maxD * (0.15**(1/3)), rH = maxD * (0.75**(1/3));
        stackData.forEach(p => {
            if (p.dist <= rC) { p.zone = 'Core'; p.neon = 'var(--neon-pink)'; }
            else if (p.dist <= rH) { p.zone = 'Mid Zone'; p.neon = 'var(--neon-green)'; }
            else { p.zone = 'Outer Band'; p.neon = 'var(--neon-cyan)'; }
        });
        stackData.sort((a,b) => a.dist - b.dist);

        // --- WORKSPACE LOGIC ---
        function switchWorkspace(mode) {
            const vis = document.getElementById('main-visualizer'), db = document.getElementById('main-database');
            const visUI = document.getElementById('sidebar-visualizer-ui'), dbUI = document.getElementById('sidebar-database-ui');
            const bV = document.getElementById('mode-visual'), bD = document.getElementById('mode-db');
            if (mode === 'visualizer') {
                vis.style.display = 'block'; db.style.display = 'none';
                visUI.style.display = 'flex'; dbUI.style.display = 'none';
                bV.classList.add('active'); bD.classList.remove('active');
                isDBMode = false;
            } else {
                vis.style.display = 'none'; db.style.display = 'block';
                visUI.style.display = 'none'; dbUI.style.display = 'flex';
                bV.classList.remove('active'); bD.classList.add('active');
                isDBMode = true; renderChromaDatabase();
            }
        }

        // --- SUBMISSION ENGINE ---
        document.getElementById('node-label').addEventListener('input', e => document.getElementById('label-counter').innerText = `${e.target.value.length} / 100`);
        document.getElementById('node-content').addEventListener('input', runAutoScanner);
        document.getElementById('manual-tags-input').addEventListener('keypress', e => { if(e.key === 'Enter') addManualTagsToPool(); });

        let currentPoolTags = new Set();

        function runAutoScanner() {
            const text = document.getElementById('node-content').value.toLowerCase();
            const words = text.match(/\b\w+\b/g) || [];
            const unique = [...new Set(words)];
            
            // Clear current automated tags, but keep manually added ones
            // Actually simpler to just track which are "manual" and which are "auto"
            const matches = stackData.filter(s => s.hashtag && unique.includes(s.hashtag.replace('#','').toLowerCase())).map(s => s.hashtag);
            
            // Add auto-tags to pool
            matches.forEach(m => currentPoolTags.add(m));
            updatePoolUI();
        }

        function addManualTagsToPool() {
            const input = document.getElementById('manual-tags-input');
            const raw = input.value.trim();
            if(!raw) return;
            const tags = raw.split(';').map(t => t.trim()).filter(t => t);
            tags.forEach(t => {
                const fmt = t.startsWith('#') ? t : '#' + t;
                currentPoolTags.add(fmt);
            });
            input.value = '';
            updatePoolUI();
        }

        function removeTagFromPool(tag) {
            currentPoolTags.delete(tag);
            updatePoolUI();
        }

        function updatePoolUI() {
            const container = document.getElementById('active-node-tags');
            if (currentPoolTags.size === 0) {
                container.innerHTML = '<span style="font-size:0.65rem; color:#444; font-style:italic;">Scanning content for matches...</span>';
                return;
            }
            container.innerHTML = '';
            currentPoolTags.forEach(tag => {
                const pill = document.createElement('div');
                pill.className = 'tag-pill';
                pill.innerHTML = `<span>${tag}</span><span class="tag-x" onclick="removeTagFromPool('${tag}')">Ã—</span>`;
                container.appendChild(pill);
            });
        }

        function calculateChromaNode() {
            const label = document.getElementById('node-label').value || 'UNTITLED_NODE';
            const content = document.getElementById('node-content').value;
            const allTags = [...currentPoolTags];
            
            if (allTags.length === 0) {
                alert("NODE_ERROR: Provide at least one semantic tag for gravitational calculation.");
                return;
            }

            const nodeEntry = { id: chromaNodes.length + 1, label, content, tags: allTags, color: 'lab(60% 0 0)' };
            chromaNodes.push(nodeEntry);
            
            // Reset Sidebar UI
            document.getElementById('node-label').value = ''; 
            document.getElementById('node-content').value = '';
            document.getElementById('manual-tags-input').value = ''; 
            currentPoolTags.clear();
            updatePoolUI();
            
            renderChromaDatabase();
        }

        function renderChromaDatabase() {
            const container = document.getElementById('db-grid-container');
            container.innerHTML = chromaNodes.length ? '' : '<div style="grid-column: 1/-1; text-align:center; opacity:0.2; padding-top:100px; font-family:Orbitron;">NO_DATA_INGESTED</div>';
            chromaNodes.forEach(node => {
                const cell = document.createElement('div'); cell.className = 'db-cell';
                cell.innerHTML = `<div class="db-swatch" style="background:${node.color}"></div><div style="flex:1"><div style="font-family:'Fira Code'; font-size:0.6rem; color:#555">NODE_${node.id}</div><div style="font-family:'Orbitron'; font-size:0.8rem; font-weight:900;">${node.label}</div><div style="font-size:0.6rem; color:var(--neon-cyan); margin-top:4px;">${node.tags.join(' ')}</div></div>`;
                container.appendChild(cell);
            });
        }

        // --- SIDEBAR UI ---
        function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`btn-${t}`).classList.add('active'); document.getElementById(`tab-${t}`).classList.add('active'); }
        function renderList(f = '') {
            const list = document.getElementById('stack-list'); list.innerHTML = ''; const term = f.toLowerCase(); const frag = document.createDocumentFragment();
            stackData.forEach((p, idx) => {
                if (f && !p.id.toString().includes(term) && !p.hashtag.toLowerCase().includes(term)) return;
                const li = document.createElement('li'); li.className = 'stack-item';
                li.innerHTML = `<div class="swatch" style="background:${p.css}; border-color:${p.neon}"></div><div style="flex:1"><div style="font-family:'Fira Code'; font-size:0.55rem; color:#888">ANCHOR_X${p.id}</div><div class="tag-label" style="color:${p.neon}">${p.hashtag || 'NULL_PTR'}</div></div>`;
                li.onmouseenter = () => highlightPoint(idx); frag.appendChild(li);
            });
            list.appendChild(frag);
        }
        function jumpTo(z) { const idx = stackData.findIndex(p => p.zone === z); if(idx !== -1) { const wrapper = document.getElementById('list-container'); wrapper.scrollTo({top: (idx / STACK_SIZE) * wrapper.scrollHeight, behavior: 'smooth'}); } }
        function doAssign() {
            const zone = document.getElementById('zone-select').value; const rawInput = document.getElementById('assign-input').value.trim(); if(!rawInput) return;
            const tags = rawInput.split(';').map(t => t.trim()).filter(t => t.length > 0);
            tags.forEach(tag => { const formattedTag = tag.startsWith('#') ? tag : '#' + tag; const target = stackData.find(p => p.zone === zone && !p.hashtag); if(target) target.hashtag = formattedTag; });
            document.getElementById('assign-input').value = ''; renderList();
        }

        // --- 3D ENGINE ---
        let scene, camera, renderer, cloud, high;
        window.onload = () => {
            const container = document.getElementById('main-visualizer');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 1, 1000);
            camera.position.set(200, 150, 200);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            const geo = new THREE.BufferGeometry(); const pos = [], col = [];
            stackData.forEach(p => { const [r, g, bl] = lab2rgb(p.L, p.a, p.b); pos.push(p.a, p.L-50, p.b); col.push(r/255, g/255, bl/255); });
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
            cloud = new THREE.Points(geo, new THREE.PointsMaterial({ size: 2.2, vertexColors: true, transparent: true, opacity: 0.6 }));
            scene.add(cloud);
            high = new THREE.Points(new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute([0,0,0], 3)), new THREE.PointsMaterial({ color: 0x00d9ff, size: 12, transparent: true, opacity: 0 }));
            scene.add(high);
            renderList(); setup3D(); animate();
            document.getElementById('search-input').addEventListener('input', e => renderList(e.target.value));
        };
        function highlightPoint(i) { const p = stackData[i]; high.position.set(p.a, p.L-50, p.b); high.material.opacity = 1; }
        function setup3D() {
            let theta = Math.PI/4, phi = Math.PI/3, radius = 350, isDragging = false; const container = document.getElementById('main-visualizer');
            const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
            const updateCam = () => { phi = Math.max(0.1, Math.min(Math.PI-0.1, phi)); camera.position.set(radius*Math.sin(phi)*Math.cos(theta), radius*Math.cos(phi), radius*Math.sin(phi)*Math.sin(theta)); camera.lookAt(0,0,0); };
            container.onmousedown = () => isDragging = true; window.onmouseup = () => isDragging = false;
            container.onmousemove = (e) => {
                if(isDragging) { theta -= e.movementX * 0.005; phi -= e.movementY * 0.005; updateCam(); }
                const rect = container.getBoundingClientRect(); mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1; mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                ray.setFromCamera(mouse, camera); const hits = ray.intersectObject(cloud); const label = document.getElementById('hover-label');
                if(hits.length > 0) { const p = stackData[hits[0].index]; label.style.display = 'block'; label.style.left = e.clientX + 'px'; label.style.top = e.clientY + 'px'; label.innerHTML = `<div style="color:var(--neon-cyan)">${p.hashtag || 'NULL'}</div><div style="font-size:10px">ID_${p.id}</div>`; } else label.style.display = 'none';
            };
            updateCam();
        }
        function animate() { requestAnimationFrame(animate); if (!isDBMode) renderer.render(scene, camera); }
        window.onresize = () => { const c = document.getElementById('main-visualizer'); camera.aspect = c.clientWidth/c.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(c.clientWidth, c.clientHeight); };
    </script>
</body>
</html>