<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChromaCore: 3D Semantic Stack</title>
    <style>
        :root {
            --bg-color: #020617;
            --sidebar-bg: #0f172a;
            --sidebar-surface: #1e293b;
            --text-main: #f1f5f9;
            --text-dim: #64748b;
            --border: #334155;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --zone-core: #f43f5e;
            --zone-habit: #10b981;
            --zone-outer: #3b82f6;
        }
        body { margin: 0; overflow: hidden; background-color: var(--bg-color); font-family: 'Inter', 'Segoe UI', sans-serif; color: var(--text-main); display: flex; height: 100vh; font-size: 14px; }
        
        /* Layout */
        #canvas-container { flex: 1; position: relative; overflow: hidden; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }
        
        #sidebar { 
            width: clamp(300px, 28vw, 360px);
            background: var(--sidebar-bg); 
            border-left: 1px solid var(--border); 
            display: flex; 
            flex-direction: column;
            z-index: 10;
            box-shadow: -10px 0 20px rgba(0,0,0,0.5);
            flex-shrink: 0; 
        }

        /* 1. Header Section */
        .sidebar-header { 
            padding: 20px; 
            background: linear-gradient(to bottom, #1e293b, #0f172a); 
            border-bottom: 1px solid var(--border);
        }
        h2 { margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 700; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; color: white; }
        h2 svg { color: var(--accent); }
        .subtitle { font-size: 0.75rem; color: var(--text-dim); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }

        /* 2. Assigner Panel (New) */
        .assigner-panel {
            padding: 15px 20px;
            background: rgba(99, 102, 241, 0.05);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .panel-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--accent); letter-spacing: 0.5px; margin-bottom: -5px; }
        
        .assign-controls { display: flex; gap: 8px; }
        .zone-select {
            background: var(--sidebar-surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: 6px;
            padding: 0 8px;
            font-size: 0.8rem;
            cursor: pointer;
            width: 80px;
        }
        .zone-select:focus { outline: 1px solid var(--accent); }

        .assign-input-group {
            flex: 1;
            display: flex;
            position: relative;
        }
        .assign-input {
            width: 100%;
            background: var(--sidebar-surface);
            border: 1px solid var(--border);
            border-radius: 6px; /* Round left corners */
            padding: 8px 36px 8px 12px;
            color: white;
            font-size: 0.85rem;
        }
        .assign-input:focus { outline: 1px solid var(--accent); border-color: var(--accent); }
        
        .assign-btn {
            position: absolute;
            right: 4px;
            top: 4px;
            bottom: 4px;
            background: var(--accent);
            border: none;
            color: white;
            border-radius: 4px;
            width: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .assign-btn:hover { background: var(--accent-hover); }

        /* 3. Search & List */
        .list-controls { padding: 10px 20px; border-bottom: 1px solid var(--border); background: var(--sidebar-bg); }
        .search-box input {
            width: 100%;
            background: var(--bg-color);
            border: 1px solid var(--border);
            padding: 8px 12px;
            color: var(--text-main);
            border-radius: 6px;
            font-size: 0.8rem;
            box-sizing: border-box;
        }
        .search-box input:focus { border-color: var(--text-dim); outline: none; }

        #stack-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        
        /* List Item Styling */
        .stack-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        .stack-item:hover { background: rgba(255,255,255,0.03); padding-left: 24px; }
        .stack-item.active { background: rgba(99, 102, 241, 0.15); border-left: 4px solid var(--accent); padding-left: 16px; }
        
        /* Flash animation for new assignments */
        @keyframes flash {
            0% { background: var(--accent); }
            100% { background: rgba(99, 102, 241, 0.15); }
        }
        .stack-item.flash { animation: flash 1s ease-out; }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            margin-right: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .item-details { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        
        .item-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-id { color: var(--text-dim); font-family: monospace; font-size: 0.7rem; }
        .item-zone { 
            font-size: 0.6rem; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; 
            padding: 1px 4px; border-radius: 3px; background: rgba(255,255,255,0.05);
        }
        
        .zone-core { color: var(--zone-core); border: 1px solid rgba(244, 63, 94, 0.2); }
        .zone-habit { color: var(--zone-habit); border: 1px solid rgba(16, 185, 129, 0.2); }
        .zone-outer { color: var(--zone-outer); border: 1px solid rgba(59, 130, 246, 0.2); }

        .list-hashtag-input {
            background: transparent;
            border: none;
            color: white;
            font-family: monospace;
            font-size: 0.9rem;
            width: 100%;
            padding: 0;
            margin: 0;
        }
        .list-hashtag-input:focus { outline: none; border-bottom: 1px solid var(--accent); }
        .list-hashtag-input::placeholder { color: rgba(255,255,255,0.15); font-style: italic; font-size: 0.8rem; }

        /* Stats Footer */
        .stats-bar {
            padding: 12px 20px;
            background: #0f172a;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        
        .stat-btn {
            flex: 1;
            background: var(--sidebar-surface);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 6px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .stat-btn:hover { background: rgba(255,255,255,0.05); color: white; border-color: var(--text-dim); }
        .stat-btn span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; }

        /* Hover Label */
        #hover-label {
            position: absolute;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            pointer-events: none;
            font-size: 0.75rem;
            display: none;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 20;
            line-height: 1.4;
        }
    </style>
    <!-- Load Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="canvas-container">
        <div id="hover-label"></div>
    </div>

    <div id="sidebar">
        <!-- Header -->
        <div class="sidebar-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                ChromaCore
            </h2>
            <div class="subtitle">10,000 Anchors â€¢ 3D Semantics</div>
        </div>

        <!-- Smart Assigner -->
        <div class="assigner-panel">
            <div class="panel-label">Quick Assign</div>
            <div class="assign-controls">
                <select id="zone-select" class="zone-select">
                    <option value="Core">Core</option>
                    <option value="Mid Zone" selected>Mid</option>
                    <option value="Outer Band">Outer</option>
                </select>
                <div class="assign-input-group">
                    <input type="text" id="assign-input" class="assign-input" placeholder="New #tag...">
                    <button id="assign-btn" class="assign-btn" title="Assign to next empty slot">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Filter Controls -->
        <div class="list-controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search ID or hashtag...">
            </div>
        </div>

        <!-- The List -->
        <ul id="stack-list">
            <!-- Items injected by JS -->
        </ul>

        <!-- Footer Stats / Navigation -->
        <div class="stats-bar">
            <button class="stat-btn" onclick="window.scrollToZone('Core')"><span style="background:var(--zone-core)"></span>Core</button>
            <button class="stat-btn" onclick="window.scrollToZone('Mid Zone')"><span style="background:var(--zone-habit)"></span>Mid</button>
            <button class="stat-btn" onclick="window.scrollToZone('Outer Band')"><span style="background:var(--zone-outer)"></span>Outer</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const STACK_SIZE = 10000;
        const CENTER = { L: 50, a: 0, b: 0 };
        
        // --- MATH & UTILS ---
        function lab2rgb(l, a, b) {
            let y = (l + 16) / 116, x = a / 500 + y, z = y - b / 200;
            const x3=x*x*x, y3=y*y*y, z3=z*z*z;
            x = 95.047 * (x3>0.008856?x3:(x-16/116)/7.787);
            y = 100.000 * (y3>0.008856?y3:(y-16/116)/7.787);
            z = 108.883 * (z3>0.008856?z3:(z-16/116)/7.787);
            x/=100; y/=100; z/=100;
            let r=x*3.2406+y*-1.5372+z*-0.4986, g=x*-0.9689+y*1.8758+z*0.0415, bl=x*0.0557+y*-0.2040+z*1.0570;
            r = r>0.0031308 ? 1.055*Math.pow(r,1/2.4)-0.055 : 12.92*r;
            g = g>0.0031308 ? 1.055*Math.pow(g,1/2.4)-0.055 : 12.92*g;
            bl = bl>0.0031308 ? 1.055*Math.pow(bl,1/2.4)-0.055 : 12.92*bl;
            return [ Math.max(0,Math.min(255,Math.round(r*255))), Math.max(0,Math.min(255,Math.round(g*255))), Math.max(0,Math.min(255,Math.round(bl*255))) ];
        }

        function halton(index, base) {
            let f=1, r=0, i=index;
            while(i>0){ f/=base; r+=f*(i%base); i=Math.floor(i/base); }
            return r;
        }

        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.L-p2.L, 2) + Math.pow(p1.a-p2.a, 2) + Math.pow(p1.b-p2.b, 2));
        }

        // --- DATA INIT ---
        const stackData = [];
        let maxDist = 0;

        // 1. Generate
        for (let i = 1; i <= STACK_SIZE; i++) {
            const rL = halton(i, 2), ra = halton(i, 3), rb = halton(i, 5);
            const L = rL * 100, a = (ra * 255) - 128, b = (rb * 255) - 128;
            const [r, g, bl] = lab2rgb(L, a, b);
            const dist = getDistance({L,a,b}, CENTER);
            if (dist > maxDist) maxDist = dist;

            stackData.push({
                id: i,
                L, a, b, r, g, bl, dist,
                hex: '#' + ((1 << 24) + (r << 16) + (g << 8) + bl).toString(16).slice(1),
                hashtag: '' // Initialize empty hashtag
            });
        }

        // 2. Zone
        const rCore = maxDist * Math.pow(0.15, 1/3);
        const rHabit = maxDist * Math.pow(0.75, 1/3); 

        stackData.forEach(p => {
            if (p.dist <= rCore) { p.zone = 'Core'; p.zoneClass = 'zone-core'; }
            else if (p.dist <= rHabit) { p.zone = 'Mid Zone'; p.zoneClass = 'zone-habit'; }
            else { p.zone = 'Outer Band'; p.zoneClass = 'zone-outer'; }
        });

        // 3. Sort
        stackData.sort((a, b) => a.dist - b.dist);


        // --- LOGIC ---
        window.scrollToZone = function(zoneName) {
            const index = stackData.findIndex(p => p.zone === zoneName);
            if (index !== -1) {
                jumpToIndex(index);
            }
        };

        function jumpToIndex(index) {
            const listEl = document.getElementById('stack-list');
            const targetLi = listEl.querySelector(`[data-index="${index}"]`);
            if (targetLi) {
                targetLi.scrollIntoView({ block: 'center', behavior: 'smooth' });
                targetLi.classList.add('flash');
                setTimeout(() => targetLi.classList.remove('flash'), 1000);
            }
        }

        window.onload = function() {
            const canvasContainer = document.getElementById('canvas-container');
            const listEl = document.getElementById('stack-list');
            const searchInput = document.getElementById('search-input');
            const assignInput = document.getElementById('assign-input');
            const assignBtn = document.getElementById('assign-btn');
            const zoneSelect = document.getElementById('zone-select');
            const hoverLabel = document.getElementById('hover-label');

            // --- THREE.JS INIT ---
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000); // Transparent-ish logic handled by css bg
            scene.fog = new THREE.Fog(0x020617, 150, 400);

            const camera = new THREE.PerspectiveCamera(60, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
            camera.position.set(160, 120, 160);

            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            canvasContainer.appendChild(renderer.domElement);

            // --- POINTS ---
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            
            stackData.forEach(p => {
                positions.push(p.a, p.L - 50, p.b); 
                colors.push(p.r/255, p.g/255, p.bl/255);
            });

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({ size: 2.5, vertexColors: true, transparent: true, opacity: 0.85 });
            const pointCloud = new THREE.Points(geometry, material);
            scene.add(pointCloud);

            // --- HIGHLIGHTER ---
            const highlightGeo = new THREE.BufferGeometry();
            highlightGeo.setAttribute('position', new THREE.Float32BufferAttribute([0,0,0], 3));
            const highlightMat = new THREE.PointsMaterial({ color: 0xffffff, size: 8, transparent: true, opacity: 0 });
            const highlighter = new THREE.Points(highlightGeo, highlightMat);
            scene.add(highlighter);

            // --- AXES ---
            const grid = new THREE.GridHelper(260, 10, 0x334155, 0x0f172a);
            scene.add(grid);

            // --- RENDER LIST ---
            function renderList(filter = '') {
                listEl.innerHTML = '';
                const term = filter.toLowerCase();
                
                // Use document fragment for perf
                const fragment = document.createDocumentFragment();

                stackData.forEach((p, index) => {
                    // Search Logic: Match ID or Hashtag
                    if (filter) {
                        const matchId = p.id.toString().includes(term);
                        const matchTag = p.hashtag.toLowerCase().includes(term);
                        if (!matchId && !matchTag) return;
                    }

                    const li = document.createElement('li');
                    li.className = 'stack-item';
                    li.dataset.index = index; 
                    
                    li.innerHTML = `
                        <div class="color-swatch" style="background-color: ${p.hex}"></div>
                        <div class="item-details">
                            <div class="item-meta">
                                <span class="item-id">#${p.id}</span>
                                <span class="item-zone ${p.zoneClass}">${p.zone === 'Mid Zone' ? 'MID' : p.zone === 'Core' ? 'CORE' : 'OUT'}</span>
                            </div>
                            <input type="text" class="list-hashtag-input" placeholder="Empty Slot" value="${p.hashtag}" readonly>
                        </div>
                    `;

                    li.addEventListener('mouseenter', () => highlightPoint(index));
                    
                    fragment.appendChild(li);
                });
                listEl.appendChild(fragment);
            }

            // --- ASSIGNER LOGIC ---
            function assignHashtag() {
                const zone = zoneSelect.value;
                let tag = assignInput.value.trim();
                
                if (!tag) return;
                if (!tag.startsWith('#')) tag = '#' + tag;

                // Find next empty
                const targetIndex = stackData.findIndex(p => p.zone === zone && !p.hashtag);

                if (targetIndex !== -1) {
                    // Update Data
                    stackData[targetIndex].hashtag = tag;
                    
                    // Clear search to ensure visibility
                    searchInput.value = '';
                    assignInput.value = '';
                    
                    // Refresh List
                    renderList();
                    
                    // Jump
                    jumpToIndex(targetIndex);
                    
                    // Update 3D tooltip if hovering
                    if (hoveredListIndex === targetIndex) {
                        // force update tooltip? handled by mousemove
                    }
                } else {
                    alert(`No empty slots available in ${zone}!`);
                }
            }

            assignBtn.addEventListener('click', assignHashtag);
            assignInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') assignHashtag();
            });

            // --- EVENTS ---
            renderList();
            searchInput.addEventListener('input', (e) => renderList(e.target.value));

            // 3D Interaction
            let hoveredListIndex = -1;
            const raycaster = new THREE.Raycaster();
            raycaster.params.Points.threshold = 3;
            const mouse = new THREE.Vector2();

            function highlightPoint(index) {
                if (index === -1) {
                    highlighter.material.opacity = 0;
                    hoverLabel.style.display = 'none';
                    return;
                }
                const p = stackData[index];
                const pos = highlighter.geometry.attributes.position.array;
                pos[0] = p.a; pos[1] = p.L - 50; pos[2] = p.b;
                highlighter.geometry.attributes.position.needsUpdate = true;
                highlighter.material.opacity = 1;
                highlighter.material.color.setHex(parseInt(p.hex.replace('#','0x')));
            }

            canvasContainer.addEventListener('mousemove', (e) => {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObject(pointCloud);

                if (intersects.length > 0) {
                    const index = intersects[0].index; 
                    if (index !== hoveredListIndex) {
                        hoveredListIndex = index;
                        highlightPoint(index);
                        
                        const p = stackData[index];
                        const tagDisplay = p.hashtag ? `<div style="color:var(--accent); font-weight:bold; margin-bottom:2px;">${p.hashtag}</div>` : '';
                        
                        hoverLabel.style.display = 'block';
                        hoverLabel.style.left = (e.clientX + 10) + 'px';
                        hoverLabel.style.top = (e.clientY + 10) + 'px';
                        hoverLabel.innerHTML = `
                            ${tagDisplay}
                            <div style="font-weight:bold; color:${p.hex}">ID: ${p.id}</div>
                            <div style="font-size:0.7em; color:#ccc">${p.zone}</div>
                        `;
                    }
                } else {
                    if (hoveredListIndex !== -1) {
                        highlightPoint(-1);
                        hoveredListIndex = -1;
                        document.querySelectorAll('.stack-item').forEach(li => li.classList.remove('active'));
                    }
                }
            });

            // Camera
            let isDragging = false;
            let theta = Math.PI/4, phi = Math.PI/3, radius = 300;

            function updateCamera() {
                phi = Math.max(0.1, Math.min(Math.PI - 0.1, phi));
                camera.position.x = radius * Math.sin(phi) * Math.cos(theta);
                camera.position.y = radius * Math.cos(phi);
                camera.position.z = radius * Math.sin(phi) * Math.sin(theta);
                camera.lookAt(0, 0, 0);
            }

            canvasContainer.addEventListener('mousedown', () => isDragging = true);
            window.addEventListener('mouseup', () => isDragging = false);
            canvasContainer.addEventListener('mousemove', (e) => {
                if(isDragging) {
                    theta -= (e.movementX) * 0.005;
                    phi -= (e.movementY) * 0.005;
                    updateCamera();
                }
            });
            canvasContainer.addEventListener('wheel', (e) => {
                radius += e.deltaY * 0.1;
                radius = Math.max(50, Math.min(500, radius));
                updateCamera();
            });

            function animate() {
                requestAnimationFrame(animate);
                if(!isDragging && hoveredListIndex === -1) {
                    theta += 0.0005; 
                    updateCamera();
                }
                renderer.render(scene, camera);
            }
            updateCamera();
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            });
        };
    </script>
</body>
</html>